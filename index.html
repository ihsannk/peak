<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Search Engine</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF.js library from Mozilla -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        #loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .pdf-list-item canvas {
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        #pdf-canvas {
            max-width: 100%;
            height: auto;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <!-- Header Section -->
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">PDF Search Engine</h1>
            <p class="text-lg text-gray-600">Select the PDFs you want to include and search for content within them.</p>
        </header>

        <main>
            <!-- PDF Selection Section -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-2xl font-semibold mb-2">1. Select PDFs to Search</h2>
                <div id="initial-loader-container" class="text-center my-4">
                    <div id="loader" class="mx-auto h-8 w-8 animate-spin rounded-full border-4 border-gray-200 border-t-blue-500"></div>
                    <p id="loading-status" class="mt-2 text-gray-600">Loading available PDFs...</p>
                </div>
                <div id="pdf-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                    <!-- PDF thumbnails and checkboxes will be inserted here by JavaScript -->
                </div>
            </div>

            <!-- Search Section -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-6">
                <h2 class="text-2xl font-semibold mb-4">2. Search Content</h2>
                <div class="flex flex-col sm:flex-row gap-4">
                    <input type="text" id="search-input" placeholder="Enter search term..." class="flex-grow w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="search-btn" class="w-full sm:w-auto bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400" disabled>Search</button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-container" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-semibold mb-4">3. Results</h2>
                <div id="results" class="text-gray-700">
                    <p>Search results will appear here.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdf-viewer-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-full max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="pdf-viewer-title" class="text-xl font-semibold truncate">PDF Viewer</h3>
                <button id="close-modal-btn" class="text-gray-500 hover:text-gray-800 text-3xl font-bold">&times;</button>
            </div>
            <div class="flex-grow p-4 overflow-auto text-center bg-gray-200">
                <canvas id="pdf-canvas"></canvas>
            </div>
            <div class="flex justify-center items-center p-4 border-t gap-4">
                <button id="prev-page-btn" class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50" disabled>Previous</button>
                <span>Page <span id="page-num">0</span> / <span id="page-count">0</span></span>
                <button id="next-page-btn" class="bg-gray-300 px-4 py-2 rounded-lg hover:bg-gray-400 disabled:opacity-50" disabled>Next</button>
            </div>
        </div>
    </div>


    <script>
        // Set the workerSrc for PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js';

        // --- CONFIGURATION ---
        // Add the filenames of the PDFs you want to include here.
        // Make sure these PDF files are in the SAME FOLDER as this HTML file.
        const PDF_FILES = [
            "act-366_2023.pdf",
            "poison-regulations-1952_3.pdf"
        ];

        // --- DOM Elements ---
        const pdfListContainer = document.getElementById('pdf-list');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const resultsContainer = document.getElementById('results');
        const initialLoader = document.getElementById('initial-loader-container');
        const loadingStatus = document.getElementById('loading-status');
        
        // Modal DOM Elements
        const modal = document.getElementById('pdf-viewer-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const pdfViewerTitle = document.getElementById('pdf-viewer-title');
        const pdfCanvas = document.getElementById('pdf-canvas');
        const pageNumSpan = document.getElementById('page-num');
        const pageCountSpan = document.getElementById('page-count');
        const prevPageBtn = document.getElementById('prev-page-btn');
        const nextPageBtn = document.getElementById('next-page-btn');

        // --- State Variables ---
        let pdfData = []; // To store file info, extracted text, and the PDF document object
        let currentPdf = { doc: null, pageNum: 1 }; // State for the PDF viewer

        // --- Initial Loading Logic ---
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            if (PDF_FILES.length === 0) {
                 loadingStatus.textContent = 'No PDFs configured. Please edit the PDF_FILES list in the script.';
                 return;
            }

            for (let i = 0; i < PDF_FILES.length; i++) {
                const filename = PDF_FILES[i];
                loadingStatus.textContent = `Loading ${filename} (${i+1}/${PDF_FILES.length})...`;
                try {
                    const pdfDoc = await pdfjsLib.getDocument(filename).promise;
                    
                    // Create thumbnail
                    const page = await pdfDoc.getPage(1);
                    const viewport = page.getViewport({ scale: 0.5 });
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;

                    // Create list item
                    const listItem = document.createElement('div');
                    listItem.classList.add('pdf-list-item', 'p-2', 'text-center');
                    listItem.innerHTML = `
                        ${canvas.outerHTML}
                        <div class="mt-2 flex items-center justify-center">
                            <input type="checkbox" id="pdf-check-${i}" data-pdf-index="${i}" class="mr-2 h-4 w-4">
                            <label for="pdf-check-${i}" class="text-sm truncate">${filename}</label>
                        </div>
                    `;
                    pdfListContainer.appendChild(listItem);
                    
                    // Extract text for searching
                    let extractedText = [];
                    for (let j = 1; j <= pdfDoc.numPages; j++) {
                        const textPage = await pdfDoc.getPage(j);
                        const textContent = await textPage.getTextContent();
                        extractedText.push(textContent.items.map(item => item.str).join(' '));
                    }
                    pdfData.push({ name: filename, content: extractedText, doc: pdfDoc });

                } catch (error) {
                    console.error(`Error loading ${filename}:`, error);
                    const errorItem = document.createElement('div');
                    errorItem.classList.add('p-2', 'text-center', 'text-red-500');
                    errorItem.textContent = `Failed to load: ${filename}`;
                    pdfListContainer.appendChild(errorItem);
                }
            }
            initialLoader.classList.add('hidden');
            searchBtn.disabled = false;
        }

        // --- Search Logic ---
        searchBtn.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') performSearch(); });

        function performSearch() {
            const query = searchInput.value.trim().toLowerCase();
            const selectedPdfIndexes = Array.from(document.querySelectorAll('#pdf-list input[type="checkbox"]:checked'))
                                             .map(cb => parseInt(cb.dataset.pdfIndex));

            if (!query || selectedPdfIndexes.length === 0) {
                resultsContainer.innerHTML = '<p>Please enter a search term and select at least one PDF.</p>';
                return;
            }

            resultsContainer.innerHTML = '';
            let foundResults = false;
            
            selectedPdfIndexes.forEach(index => {
                const pdf = pdfData[index];
                if (!pdf) return;

                const fileResultContainer = document.createElement('div');
                let foundInFile = false;

                pdf.content.forEach((pageText, pageIndex) => {
                    const lowerPageText = pageText.toLowerCase();
                    const pageNum = pageIndex + 1;
                    let startIndex = 0;
                    let pageSnippets = [];

                    while ((startIndex = lowerPageText.indexOf(query, startIndex)) !== -1) {
                        foundInFile = true;
                        const contextRadius = 70;
                        const snippetStart = Math.max(0, startIndex - contextRadius);
                        const snippetEnd = Math.min(pageText.length, startIndex + query.length + contextRadius);
                        const originalTerm = pageText.substring(startIndex, startIndex + query.length);
                        let snippet = pageText.substring(snippetStart, snippetEnd);
                        const escapedTerm = originalTerm.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
                        snippet = snippet.replace(new RegExp(escapedTerm, 'gi'), `<strong class="bg-yellow-200 font-semibold">${originalTerm}</strong>`);
                        if (snippetStart > 0) snippet = '... ' + snippet;
                        if (snippetEnd < pageText.length) snippet = snippet + ' ...';
                        pageSnippets.push(snippet);
                        startIndex += query.length;
                    }

                    if (pageSnippets.length > 0) {
                        const pageResultDiv = document.createElement('div');
                        pageResultDiv.classList.add('mt-2', 'pl-4', 'border-l-2', 'border-gray-200');

                        const pageHeader = document.createElement('div');
                        pageHeader.classList.add('flex', 'justify-between', 'items-center');
                        pageHeader.innerHTML = `<p>Found on page <span class="font-bold">${pageNum}</span>:</p>`;

                        const goToPageBtn = document.createElement('button');
                        goToPageBtn.textContent = 'View Page â†’';
                        goToPageBtn.classList.add('bg-green-600', 'text-white', 'font-bold', 'py-1', 'px-3', 'rounded-md', 'hover:bg-green-700', 'transition', 'text-sm');
                        goToPageBtn.onclick = () => openPdfViewer(index, pageNum);
                        pageHeader.appendChild(goToPageBtn);

                        pageResultDiv.appendChild(pageHeader);
                        pageSnippets.forEach(snippetText => {
                            const snippetP = document.createElement('p');
                            snippetP.classList.add('text-gray-600', 'italic', 'mt-1', 'pl-2', 'text-sm');
                            snippetP.innerHTML = snippetText;
                            pageResultDiv.appendChild(snippetP);
                        });
                        fileResultContainer.appendChild(pageResultDiv);
                    }
                });

                if (foundInFile) {
                    foundResults = true;
                    const resultDiv = document.createElement('div');
                    resultDiv.classList.add('mb-4', 'p-4', 'border', 'border-gray-200', 'rounded-lg', 'shadow-sm');
                    const fileNameHeader = document.createElement('h3');
                    fileNameHeader.classList.add('text-lg', 'font-semibold', 'text-blue-700', 'mb-2');
                    fileNameHeader.textContent = pdf.name;
                    resultDiv.appendChild(fileNameHeader);
                    resultDiv.appendChild(fileResultContainer);
                    resultsContainer.appendChild(resultDiv);
                }
            });

            if (!foundResults) {
                resultsContainer.innerHTML = '<p>No results found for your query in the selected PDFs.</p>';
            }
        }

        // --- PDF Viewer Logic ---
        function openPdfViewer(pdfIndex, pageNumToShow) {
            const pdfItem = pdfData[pdfIndex];
            if (!pdfItem) return;

            currentPdf.doc = pdfItem.doc;
            currentPdf.pageNum = pageNumToShow;

            pdfViewerTitle.textContent = pdfItem.name;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            
            pageCountSpan.textContent = currentPdf.doc.numPages;
            renderPage(currentPdf.pageNum);
        }

        async function renderPage(num) {
            if (!currentPdf.doc) return;
            const page = await currentPdf.doc.getPage(num);
            const viewport = page.getViewport({ scale: 1.5 });
            const canvasContext = pdfCanvas.getContext('2d');
            pdfCanvas.height = viewport.height;
            pdfCanvas.width = viewport.width;
            await page.render({ canvasContext, viewport }).promise;
            pageNumSpan.textContent = num;
            prevPageBtn.disabled = (num <= 1);
            nextPageBtn.disabled = (num >= currentPdf.doc.numPages);
        }

        closeModalBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentPdf.doc = null;
        });

        prevPageBtn.addEventListener('click', () => {
            if (currentPdf.pageNum <= 1) return;
            currentPdf.pageNum--;
            renderPage(currentPdf.pageNum);
        });

        nextPageBtn.addEventListener('click', () => {
            if (currentPdf.pageNum >= currentPdf.doc.numPages) return;
            currentPdf.pageNum++;
            renderPage(currentPdf.pageNum);
        });

    </script>
</body>
</html>
